了解！添付の `triage.py` / `main.py` を前提に、**既存カードへの最小差分（5点）＋画像プレビューの“大きめ表示／クリック拡大”＋情報圧縮＆ビジュアル化**までを一気通貫で落とし込んだ**詳細実装計画書**です。
（コードの現状：レポート生成は `triage.py`、Embedとページャ/ボタンは `main.py` の `build_record_embed` と `ReportPaginator` で実装済み。 ）

---

# 改修ゴール（要約）

* **プレビュー画像**：カードに**サムネ**＋**大きめプレビュー**（クリックでDiscordの標準ビューアに拡大）。
* **元メッセージ非参照でも表示**：可能な限り**一度DL→Botメッセージに添付**して `attachment://…` でEmbedへ表示（=「毎回元を見に行かない」）。([Discord][1])
* **情報圧縮＆ビジュアル**：見るべき要素だけを**2カラム**に再配置、メトリクスは**ミニバー**で可視化、操作は**ボタン**に集約。([Discord][2])
* **閲覧注意（RED）**は**SPOILER添付**でぼかし→クリック展開。([Discordサポート][3])
* **エフェメラル**で配布、必要に応じて\*\*#mod-bot-log へ転送\*\*（エフェメラル→公開への“変換”は不可のため**新規投稿**）。([Discord][4])

---

# 変更設計（最小差分 5点）

## 1) プレビュー画像の追加（thumbnail + 大きめ image）

**方針**

* 画像候補は次の優先度で決定：**messages\[].attachments\[*] (image/*) > embeds.image/thumbnail**。
* **添付が取れたらDL→Botメッセージに添付→`attachment://…`** で `set_image`/`set_thumbnail`。以後は**Bot側添付**を参照するため、元ポストへ行かなくてもプレビューが出る。([Discord][1])
* クリック時はDiscord既定の**拡大ビューア**が開く（`set_image`）。([discord.js][5])

**実装ポイント**

* `ReportPaginator` にプレビュー選択 → 添付生成のユーティリティを追加（`_pick_preview()`, `_build_files_for_embed()`） → `send_initial()` / ページ送り時に `files=` を渡す。
* 画像URL直参照にフォールバック（編集時に新しい添付を差し込まない場合）。**確実性を上げるには添付方式推奨**。([GitHub][6])

## 2) SPOILER（閲覧注意）対応

* RED（暴力/ゴア/未成年疑い）は**添付ファイル名を `SPOILER_*.png`** にして送信 → **ぼかし表示** → クリックで展開。([Discordサポート][3])

## 3) 情報圧縮（見るべきものだけ）

* Embed上部：**Severity（色）/ 1行理由（reason\_jp）/ Author / Created / ジャンプリンク**
* 左カラム：**Ratings**（g/s/q/e を **ミニバー**で表示）
* 右カラム：**NSFW/Exposure**（`nsfw_margin/ratio/nsfw_sum` と `exposure/violence/minors`）→ **数値＋ミニバー**
* 下段：**Top Tags（上位4件）** / **NudeNet（上位3件）** のみ
* Embedの**文字数上限（title 256 / desc 2048 / fields 25 / 合計6000）** を厳守。([Discord][7])

## 4) ボタン整理（直感的に）

* **Primary**: `Notify`（返信で依頼）
* **Secondary**: `Remind` / `Log`（#mod-bot-logへ転送）
* **Danger**: `Delete`
* **Link Buttons**: `Open Message`（message\_link）/ `Open Original`（CDN） を追加（リンクは**Link Button**で実装）。([Discord.js ガイド][8])
* 前/次 ページャは現状維持（◀/▶）。

## 5) 画像ALT/説明の自動生成（任意）

* `Top Tags` と `rule_title` を短く整形 → **添付 description** として付与（読み上げ/視認性の補助）。([Discord][9])

---

# 具体タスク（コードへの差分指示）

## A. データ供給（添付メタの持ち回し）— `triage.py`

* `p3_findings` の `messages[0].attachments[]` に最小メタ（`id, filename, url, content_type, width, height, is_spoiler`）を格納する。

  * すでに `messages[0].author_id/is_nsfw_channel` を使っているので同列に追加してOK。
* **DoD**：`load_findings()` でレコードに attachments が存在する。

> *補足*: もしp2段階でメタを持っていない場合でも、`ReportPaginator` 側で **lazyに `fetch_message()`** して attachments を補完できるようにする（既存 `_message_targets()` を流用）。

## B. Embedの再設計 — `main.py`

1. **メトリクスのミニバー関数**を追加

   ```py
   def _bar(x: float, width: int = 10) -> str:
       n = max(0, min(width, int(round(x*width))))
       return "█"*n + "▁"*(width-n)
   ```
2. **`build_record_embed()` を再配置**

   * Header：`title=rule_title`（URL=message\_link）, **color=severity**（既存関数）。
   * Fields（inline=True）：

     * Ratings：`g/s/q/e` を `0.55 (████▁▁▁▁)` のように表示
     * NSFW：`margin/ratio/nsfw_sum`
     * Exposure：`exposure/violence/minors`
   * 下段：Top Tags（4件）, NudeNet（3件）
   * 文字数は前記上限内に収める（Title/Field数）。 ([Discord][7])
3. **プレビュー画像**

   * `set_thumbnail(url=att_url)` + `set_image(url="attachment://preview.jpg")`（添付方式）を採用。([Discord][1])
   * 画像がなければ `set_image(None)`。([discord.js][5])
4. **Link Buttons**

   * `discord.ui.Button(style=discord.ButtonStyle.link, url=record["message_link"], label="Open Message")`
   * `Open Original` は `attachments[0]["url"]` を使用。([Discord.js ガイド][8])

## C. ファイル添付の扱い — `ReportPaginator`

* 追加：`_pick_preview(record) -> Optional[Preview]` で最適な画像候補を選ぶ

  * 条件：`content_type.startswith("image/")`、幅・高さ・サイズで最良を選択
* 追加：`_build_files_for_embed(record) -> List[discord.File]`

  * 初回はHTTPでDL → `BytesIO` から `discord.File(fp, filename)` を生成（REDは `SPOILER_preview.jpg`）。([Discordサポート][3])
  * 以後のページ切替は**添付差替**が重い場合、**thumbnail=CDN / image=attachment**の併用で負荷分散
* `send_initial()` と `on_prev/on_next` の送出を

  * `interaction.followup.send(embed=..., view=self, files=files, ephemeral=True)`
  * `interaction.response.edit_message(embed=..., view=self, attachments=files or discord.utils.MISSING)`（添付差替が必要なとき）へ。
* フォールバック：DL失敗→`set_image(url=att_url)` でCDN直参照に切替。([Discord][10])

## D. ボタン処理の追加/改修 — `ReportPaginator`

* 既存の `Notify/Remind/Delete/Log` は現状踏襲（通知は**投稿者のみメンション**で reply）。
* 追加：Link Button 2種（Open Message / Open Original）。([Discord.js ガイド][8])
* `on_log` は**エフェメラル→公開不可**のため、#mod-bot-log に**新規メッセージを投稿**（現状通り）。([Stack Overflow][11])

---

# 情報設計（見た目）

```
[ SEVERITY COLOR BAR ]
TITLE (Rule ID/Title)        [Open Message] [Open Original]
Author  |  Created
────────────────────────────────────────────
🧮 Ratings      g 0.55 ███▌▁▁▁▁  s 0.06 █▁▁▁▁▁▁▁▁  q 0.39 ███▎▁▁▁▁  e 0.21 ██▎▁▁▁▁▁▁
🔞 NSFW         margin -0.17  ratio 0.49 ████▌▁▁▁  nsfw_sum 0.00
👁 Exposure     exposure 0.00  violence 0.00  minors 0.00
🔖 Tags         monochrome:0.97, simple background:0.76, text focus:0.66…
(右側) 画像プレビュー（thumbnail + 大きめimage）
```

* **2カラム**：フィールドを `inline=True` で左右表示（上限25 fields・合計6000文字に収まるよう制御）。([Discord][7])
* **クリック拡大**：`set_image` の画像をクリックするとDiscord標準ビューアで**原寸に拡大**。([discord.js][5])

---

# 動作仕様と制約（実装時に気をつけること）

* **エフェメラル**：インタラクション応答時のみ送信可／**公開化は不可** → **「転送」ボタンで#mod-bot-logへ新規投稿**。([Discord][4])
* **添付の参照**：`attachment://` を使う時は**同メッセージに添付したファイル名**と一致させる。([Discord][1])
* **Embed上限**：文字やフィールド数の超過で送信失敗にならないよう**短文＋上位タグ少数**に絞る。([Discord][7])
* **SPOILER**：ファイル名先頭の `SPOILER_` でぼかし付与。([Discordサポート][3])

---

# 受け入れ基準（DoD）

1. `/report format=embed` のカードに**画像プレビュー**（thumbnail＋大きめimage）が表示され、**クリック拡大**できる。
2. REDのカードは**ぼかし付き**で表示（クリックで展開）。
3. 情報は**2カラム**で圧縮表示、**上限文字数**に収まり、**Top Tags 4 / NudeNet 3**のみ。
4. **Open Message / Open Original** のLink Buttonが機能。
5. **Notify/Remind/Delete/Log**は現状通り動作。

---

# 実装スプリント（目安）

* **タスク1（0.5d）**：`triage.py` で `attachments[]` を findings に同梱（lazy補完fallback込み）。
* **タスク2（0.5d）**：`build_record_embed` の再配置＆ミニバー実装。
* **タスク3（0.5d）**：`ReportPaginator` にプレビュー添付処理（SPOILER/Link Buttons含む）。
* **タスク4（0.5d）**：E2E（RED/ORANGE/モノクロ系）での可視性検証／Embed制限内の確認。([Discord][7])

---

## 参考（一次情報）

* **添付→Embed参照 `attachment://…`**（公式リファレンス／ガイド）([Discord][1])
* **Embed画像/サムネAPI**（set\_image / set\_thumbnail）([discord.js][5])
* **メッセージフラグ：エフェメラル（64）／応答フロー** ([Discord][4])
* **Embedの制限（文字/フィールド/総量）**（安全ガイド/コミュニティ）([Discord][7])
* **SPOILER添付**（公式ヘルプ）([Discordサポート][3])
* **Message Components/Link Buttons**（公式 & ガイド）([Discord][2])

---

必要なら、この計画をそのまま反映する**差分パッチ雛形**（`ReportPaginator` の `send_initial/on_prev/on_next` と `build_record_embed` の改修、`triage.py` の attachments 供給）を出します。

[1]: https://discord.com/developers/docs/reference?utm_source=chatgpt.com "API Reference | Documentation | Discord Developer Portal"
[2]: https://discord.com/developers/docs/components/using-message-components?utm_source=chatgpt.com "Using Message Components | Documentation"
[3]: https://support.discord.com/hc/en-us/articles/360022320632-Spoiler-Tags?utm_source=chatgpt.com "Spoiler Tags!"
[4]: https://discord.com/developers/docs/interactions/receiving-and-responding?utm_source=chatgpt.com "Interactions | Documentation | Discord Developer Portal"
[5]: https://discord.js.org/docs/packages/builders/1.11.1/EmbedBuilder%3AClass?utm_source=chatgpt.com "EmbedBuilder (builders - 1.11.1)"
[6]: https://github.com/discord/discord-api-docs/issues/6694?utm_source=chatgpt.com "Image embeds not always showing · Issue #6694 · discord ..."
[7]: https://discord.com/safety/using-webhooks-and-embeds?utm_source=chatgpt.com "Using Webhooks and Embeds"
[8]: https://discordjs.guide/interactive-components/buttons?utm_source=chatgpt.com "Buttons"
[9]: https://discord.com/developers/docs/components/reference?utm_source=chatgpt.com "Component Reference | Documentation"
[10]: https://discord.com/developers/docs/resources/message?utm_source=chatgpt.com "Messages Resource | Documentation"
[11]: https://stackoverflow.com/questions/69241664/discord-interaction-change-a-message-from-ephemeral-to-public?utm_source=chatgpt.com "Discord Interaction, change a message from ephemeral to ..."
