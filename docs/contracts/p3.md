# p3 出力契約（JSONL / CSV）

`out/p3_findings.jsonl` と `out/p3_report.csv` の構造を固定し、互換性を破壊する変更を早期検知するための契約です。本書の内容は CLI 実装とテストで担保され、運用では契約チェックコマンド（後述）を利用します。

## JSONL（`out/p3_findings.jsonl`）

### 必須フィールド

| フィールド | 型 | 説明 |
|-----------|----|------|
| `severity` | `"red" | "orange" | "yellow" | "green"` | 検知の深刻度。 |
| `rule_id` | `string` または `null` | 適用ルール ID。未解決時は `null`。CSV では空文字列に変換。 |
| `rule_title` | `string` または `null` | ルール表示名。Embed 表示では `rule_title → rule_id → 既定文言` の順にフォールバック。 |
| `reasons` | `string` の配列 | 人が読める根拠メッセージ。 |
| `metrics` | オブジェクト | 数値中心のメトリクス。`additionalProperties` を許容し将来拡張に備える。 |

### 任意フィールド（抜粋）

- `message_link`, `author_id`, `is_nsfw_channel`, `created_at`（ISO 8601）
- `wd14.rating.*`, `wd14.general`, `wd14.general_raw`
- `nudity_detections`, `xsignals.*`
- `metrics.winning` / `metrics.dsl`（DSL 移行後に追加予定のキー。現状は省略可）
- `messages[*].attachments[*]`：p0 スキャン由来の添付メタデータ。最小構成は `{id, filename, content_type, file_size, url, source}`。`url` は期限付きであるため、利用時は失効を考慮する。

### 文字コードとフォーマット

- UTF-8 / LF（`\n`）で 1 レコード 1 行の JSON を出力
- `json.dump(..., ensure_ascii=False)` を使用し、非 ASCII 文字をエスケープしない
- 既存キーの名称・型は変更禁止。フィールドの追加は許可（下位互換）

### JSON Schema

`docs/contracts/p3_findings.schema.json` を参照。Draft-07 ベースで必須キー・型のみを拘束し、その他のプロパティは許容します。

## CSV（`out/p3_report.csv`）

### 列順（固定ヘッダ）

```
severity, rule_id, rule_title, message_link, author_id, is_nsfw_channel,
wd14_rating_general, wd14_rating_sensitive, wd14_rating_questionable, wd14_rating_explicit,
top_tags, nudity_tops, exposure_score, placement_risk_pre,
nsfw_margin, nsfw_ratio, nsfw_general_sum, violence_tags, animals_sum, reasons
```

### 列値の充当ルール

- `severity`, `rule_id`, `rule_title`, `reasons`：JSONL から転記。`rule_id`/`rule_title` の `null` は空文字列へ。
- `message_link`, `author_id`, `is_nsfw_channel`: JSONL の同名フィールド（`messages[0]` のバックフィルも許容）
- `wd14_rating_*`: `wd14.rating` を 0.0 でフォールバック
- `top_tags`: `wd14.general` から上位タグをフォーマット
- `nudity_tops`: `nudity_detections` の上位スコアをフォーマット
- `exposure_score`: `metrics.exposure_score` を最優先。未定義時は従来の NudeNet 計算結果を利用。
- `placement_risk_pre`: `metrics.placement_risk` を優先し、未定義なら `xsignals.placement_risk_pre`
- `nsfw_margin` / `nsfw_ratio` / `nsfw_general_sum`: `metrics` で上書き、存在しない場合は従来計算
- `violence_tags`: `top_tags` から暴力タグ（設定ファイル由来）を抽出
- `animals_sum`: `metrics.animals_sum` を利用

### 出力形式

- UTF-8 / LF / `newline=""` で書き込み
- `csv.DictWriter` の `fieldnames` は上記ヘッダと完全一致させ、順序変更は禁止
- 列の追加は末尾のみ許可。中間への挿入や既存列名・順序の変更は禁止

## 契約チェック手順

```
python -m app.cli_scan --analysis out/p2_analysis.jsonl --findings out/p3_findings.jsonl
python -m app.cli_report --findings out/p3_findings.jsonl --out out/p3_report.csv
python -m app.cli_contract check-findings --path out/p3_findings.jsonl
python -m app.cli_contract check-report   --path out/p3_report.csv

任意で `--csv-attachments` を付与すると、`out/p3_report_ext.csv` に添付サマリー（件数・先頭添付の ID/ファイル名/Content-Type/URL）が追加出力されます。既定の `p3_report.csv` の列構成は変わりません。
```

CI では `cli_contract` の戻り値を監視し、0 以外で失敗として扱ってください。

## 互換性ポリシー

- JSONL/CSV ともに、既存キーの**削除・名称変更・型変更・順序変更**は禁止
- JSONL のフィールド追加、CSV の末尾列追加のみ許容
- 契約が破綻する変更を行う場合は本書と Schema を更新し、検証 CLI/テストを同時に調整すること

## 参考

- triage: `app/triage.py`
- findings writer: `app/p3_stream.py`
- embed: `app/main.py::build_record_embed`
- 既存ワークフロー: `docs/runpod_batch_runbook.md`
