# 非公式 NovelAI サーバー向け「過去画像モデレーション BOT」環境構築 & 初期設定 手順書（実装担当者向け・v1.0）

> 目的：**過去投稿の全画像を機械走査**→**ルール抵触“疑い”を抽出**→**投稿者へ削除依頼（返信アンカーつき）**→**期限経過でモデ側が削除**の運用を安全・再現可能に行うための環境構築と初期設定のSOP。
> 対象：Discord Bot（Python / discord.py 2.x）。
> タイムゾーン：JST（Asia/Tokyo）。

---

## 0) 事前確認（規約・方針）

* **最新の規約・コミュニティガイドライン**：2025-09-29発効。成人向けは**18+の年齢制限（NSFW）空間に限定**、未成年の性的描写（実在/架空/擬人化/AI生成含む）は全面禁止。今回のBOTは**疑いの拾い上げと通知**に徹する（自動削除はしない）。 ([Discordサポート][1])
* **セルフボット禁止**：**ユーザーアカウントでの自動化は不可**。**Botアカウント**で実行する。 ([Discordサポート][2])
* **メッセージコンテンツIntent**：**100サーバー未満**のBotは開発者ポータルで有効化可能。**100以上**は審査対象。今回は**画像添付の解析が中心**のため必須ではないが、将来のテキスト審査に備え**有効化を推奨**。 ([Discord 開発者サポート][3])
* **レート制限**：**グローバル 50 req/s**。HTTP 429 の `X-RateLimit-*` と `retry_after` を尊重。 ([Discord][4])

---

## 1) Discord Developer Portal 設定

### 1-1. アプリ & Bot 作成

1. Developer Portal → *New Application* → 名前付与。
2. *Bot* タブ → **Add Bot** → Token を**控える（漏洩厳禁）**。Botトークンは機密資格情報。 ([Discord][5])

### 1-2. Intent（推奨）

* *Bot* → **Presence/Guild Members（不要）**はOFF、**Message Content**は**ON（推奨）**。**100サーバー以上**で運用する場合は**Privileged Intent申請**が必要。 ([Discord 開発者サポート][3])

### 1-3. 追加スコープ & 権限（招待URL）

* *OAuth2 → URL Generator*：**`bot`** と **`applications.commands`** をチェック。
* **Bot Permissions**（最低限）：

  * **View Channels** / **Read Message History**（過去ログ走査に必須） ([Discord][6])
  * **Send Messages**（削除依頼を返信で送る）
  * **Manage Messages**（期限経過後の削除に必要） ([Discord.js ガイド][7])
* 生成されたURLでサーバーに招待（**Manage Server**権限者が実行）。 ([Discord.js ガイド][7])

> メモ：OAuth2/URLは**`scope=bot%20applications.commands`**形式。必要権限はURLジェネレータでチェックする（permissions整数は自動計算）。 ([Discord.js ガイド][7])

---

## 2) サーバー側の初期設定（運用面）

1. **年齢制限（18+）の整理**：成人向け画像は**年齢制限チャンネル**へ集約。足りない場合は作成する。 ([Discordサポート][8])
2. **モデ用ログチャンネル**を作成（例：`#mod-bot-log`）。BOTに**View/Send/Embed**を付与。
3. **AutoMod（テキスト面の予防）**：

   * Commonly Flagged Words プリセット／Custom Keywords（正規表現も可）で**“loli/shota/child/teen/未成年を想起させる語”**をブロックorレビュー。 ([Discordサポート][9])

---

## 3) ランタイム環境の構築（Linux/Windows可：例はUbuntu 22.04+）

### 3-1. Python & 仮想環境

```bash
# Python 3.11+ 推奨
sudo apt-get update && sudo apt-get install -y python3.11 python3.11-venv

mkdir -p ~/novelai-modbot && cd ~/novelai-modbot
python3.11 -m venv .venv
source .venv/bin/activate
python -m pip install --upgrade pip
```

### 3-2. 依存パッケージ（最小）

```bash
pip install "discord.py>=2.4" pillow imagehash numpy
pip install onnxruntime  # CPU
# GPUを使う場合: pip install onnxruntime-gpu  (環境に合わせて)
pip install nudenet      # 露出部位検出（OSS）
pip install python-dotenv
```

* `discord.py`：Bot本体・スラッシュコマンド。 ([Discord.py][10])
* `imagehash`：**pHash**等で**重複画像スキップ**用の指紋化。 ([GitHub][11])
* `onnxruntime`：**WD14 タガー（ONNX）**の推論ランタイムとして利用。 ([Hugging Face][12])
* `nudenet`：**露出部位検出**（breasts/genitals などの物体検出）。 ([PyPI][13])

### 3-3. プロジェクト構成（雛形）

```
novelai-modbot/
  ├─ .env.example
  ├─ app/
  │   ├─ main.py              # エントリ
  │   ├─ config.py            # 設定/定数
  │   ├─ discord_client.py    # Bot起動・スラコマ
  │   ├─ crawler.py           # 全チャンネル/スレッド走査
  │   ├─ analyzer.py          # WD14 / NudeNet 推論
  │   ├─ rules.py             # 赤/橙/黄 判定
  │   ├─ notifier.py          # 返信通知（削除依頼）/期限管理
  │   ├─ store.py             # SQLite/CSV
  │   └─ util.py              # pHash, URL正規化, 進捗
  └─ models/
      └─ wd14/                # ONNXモデル類（初回DL後に配置）
```

### 3-4. 環境変数（`.env`）

```dotenv
DISCORD_BOT_TOKEN=xxxx
GUILD_ID=123456789012345678
DUE_HOURS=72
LOG_CHANNEL_ID=000000000000000000  # #mod-bot-log（任意）
TZ=Asia/Tokyo
```

---

## 4) 画像タグ推定モデル（WD14）セットアップ

1. **モデル選定**：まずは **`SmilingWolf/wd-v1-4-swinv2-tagger-v2`** か **`...vit-tagger-v2`** を採用（rating+各種タグに対応）。 ([Hugging Face][14])
2. **取得**（例：手動DLして `models/wd14/` に配置。ONNX推論を推奨）

   * モデルカードに沿ってファイルを取得（`model.onnx`, `tags.csv` 等）。 ([Hugging Face][15])
3. **推論**：`onnxruntime`で実行し、**rating（general/sensitive/questionable/explicit）**や **loli/shota/child/teen** 等のタグスコアを読む。しきい値は後述。 ([Hugging Face][12])

---

## 5) 露出検出（NudeNet）セットアップ

* `from nudenet import NudeDetector; detector = NudeDetector(); detector.detect("image.jpg")`（クラスとスコア/矩形が返る）。 **EXPOSED_* ラベル群**を主に参照。 ([PyPI][13])
* 参考：NudeNetのクラス定義や使用例（OSSドキュメント/README）。 ([GitHub][16])

---

## 6) Discord API アクセス実装の前提

### 6-1. 権限とリンク

* **過去ログ取得**には **View Channels** と **Read Message History** が必要。 ([Discord][17])
* **削除**には **Manage Messages** が必要。 ([Discord.js ガイド][7])
* **ジャンプリンク**は `https://discord.com/channels/{guild_id}/{channel_id}/{message_id}` 形式で生成し、**各ヒットに必ず保存**。ユーザー操作でのコピー手順はヘルプに記載あり。 ([Discordサポート][18])

### 6-2. 返信（削除依頼）の設計

* **元投稿への返信**（`message_reference`）で通知。`allowed_mentions` により**投稿者のみ**メンション、**replied_user=false** で**自動メンション抑止**。 ([Discord][17])

### 6-3. スレッド/アーカイブ

* **アーカイブ済み含むスレッド列挙**→必要なら**自動Unarchive/Join**して返信可能（APIは一覧・参加・検索を提供）。 ([Discord][19])

### 6-4. 添付画像の扱い

* **attachments[].url / proxy_url / content_type** を使用。Discordの**CDN添付URLは署名つきで期限がある**ため、古い投稿は**再取得でURL更新**する実装を入れる。 ([discord.js][20])

---

## 7) 最小コード断片（動作確認用）

> 目的：環境と権限が正しく通るかの**スモークテスト**。本実装はCodexに委譲想定。

```python
# app/main.py
import os, asyncio, discord
from datetime import datetime, timedelta, timezone

TOKEN = os.environ["DISCORD_BOT_TOKEN"]
JST = timezone(timedelta(hours=9))

intents = discord.Intents.default()
# 画像添付主体なら必須ではないが将来拡張用にON推奨（100サーバー以上は審査）
intents.message_content = True  # ※要ポータル設定

bot = discord.Client(intents=intents)
tree = discord.app_commands.CommandTree(bot)  # スラッシュコマンド用

def jump_link(gid, cid, mid) -> str:
    return f"https://discord.com/channels/{gid}/{cid}/{mid}"  # 公式形式

@tree.command(name="ping", description="生存確認")
async def ping(interaction: discord.Interaction):
    await interaction.response.send_message("pong")

@tree.command(name="notify", description="指定メッセージへ削除依頼を返信")
async def notify(inter: discord.Interaction, channel_id: str, message_id: str, due_hours: int = 72):
    ch = await bot.fetch_channel(int(channel_id))
    msg = await ch.fetch_message(int(message_id))
    due = datetime.now(JST) + timedelta(hours=due_hours)
    allowed = discord.AllowedMentions(everyone=False, roles=False, users=[msg.author], replied_user=False)
    content = (f"{msg.author.mention} この投稿はルール抵触の可能性があります。**ご本人での削除**をお願いします。\n"
               f"対象: {jump_link(msg.guild.id, msg.channel.id, msg.id)}\n"
               f"期限: {due:%Y-%m-%d %H:%M} JST")
    await msg.reply(content=content, allowed_mentions=allowed)
    await inter.response.send_message("通知しました。", ephemeral=True)

@bot.event
async def on_ready():
    await tree.sync()  # ギルド未指定→全体同期（初回は時間がかかる）
    print(f"Ready as {bot.user}")

bot.run(TOKEN)
```

* `message.reply(..., allowed_mentions=..., replied_user=False)` により**投稿者だけ**へ通知、**自動メンション抑止**。 ([Discord][17])
* スラッシュコマンドは**`applications.commands`スコープ**が必要。 ([Discord][21])

---

## 8) スキャナの初期走査手順（実装時の注意）

1. **チャンネル列挙 → メッセージ履歴**
   `TextChannel.history(limit=None, oldest_first=True)` を用い、**添付/埋め込み画像**を抽出。429時は`retry_after`で待機。 ([Discord.py][22])
2. **スレッド（アクティブ/アーカイブ）**
   トピック「Threads」の**アーカイブ列挙**エンドポイントで取得→必要なら**Join**→返信可能。 ([Discord][19])
3. **重複回避**
   画像DL前にURL正規化＋**pHash**で既処理判定（距離閾値例：≤5）。 ([GitHub][11])
4. **WD14 / NudeNet 推論**

   * WD14の**rating**と**年少想起タグ**（`loli, shota, child, teen, young, flat_chest...`）を取り出し。 ([Hugging Face][14])
   * NudeNet の**EXPOSED_***スコアを補助指標に。 ([PyPI][13])
5. **赤/橙/黄 ルール**（初期案）

   * **赤**：年少タグ合算が閾値以上（未成年性的描写の疑い）
   * **橙**：WD14 `questionable/explicit` または NudeNet高スコア **かつ** チャンネルが18+でない（配置違反疑い）
   * **黄**：弱露出 + 若年風特徴の複合（要レビュー）
6. **出力**
   `message_link / author_id / channel_id / detectors / tags / scores / rule / is_nsfw_channel` を**CSV/SQLite**に保存。**ジャンプリンク必須**。

---

## 9) 期限管理と削除

* **依頼**：元投稿へ**返信**（テンプレ文言・JST期限）
* **リマインド**：同スレッドで追記
* **エスカレーション（削除）**：期限超過→`fetch_message` で**存在確認**→**Manage Messages** 権限で削除（監査理由つき）。 ([Discord.js ガイド][7])

---

## 10) データ保持とプライバシー

* **保存最小化**：**ジャンプリンク**、タグ/スコア、pHash、ヒット理由、期限/ステータスのみ。
* **添付URLの扱い**：DiscordのCDN添付は**署名付きで期限あり**。再検証時は**メッセージ再取得**で最新URLを得る。 ([Discord][23])
* **ポリシー**：Botの**プライバシーポリシー**に目的・保持期間・削除手順を明記。

---

## 11) しきい値（初期値・要調整）

* WD14 `questionable ≥ 0.35` **or** `explicit ≥ 0.20` → **橙**
* **年少タグ合算** ≥ `T_minor` → **赤**（FP抑制のため**積算方式**を採用）
* NudeNet `score ≥ 0.6` が N 箇所以上 → **橙**

> パイロット（100〜300枚）で混同行列（TP/FP/FN）をとり、**赤の再現率**を優先調整。

---

## 12) 運用SOP（抜粋）

* **日次**：差分スキャン → **赤/橙**優先レビュー → `/notify`
* **48–72h**：未対応に `/remind`
* **72–120h**：未対応を `/escalate`（モデ削除）
* **週次**：しきい値/NG語の見直し、FP/FNレビュー
* 429多発時：**待機時間自動延長**（`X-RateLimit-Scope: global` 確認） ([Discord 開発者サポート][24])

---

## 13) 参考：代替の一括エクスポート運用（任意）

* **DiscordChatExporter**（Botトークン対応）で**JSON/CSV/HTML**出力→ローカルで画像URL群をバッチ解析。**ユーザートークン利用はセルフボット相当で非推奨**。 ([GitHub][25])

---

## 14) 参考リンク（公式中心）

* **サービス利用規約の更新（2025/09/29発効）** / **コミュニティガイドライン** ([Discordサポート][1])
* **Privileged Intent（Message Content）**：100サーバー以上で審査／FAQ・申請手順 ([Discord 開発者サポート][3])
* **レート制限（Global 50 rps）** / **種類別レートリミット** ([Discord][4])
* **Permissions / OAuth2 招待**（`bot` & `applications.commands`） ([Discord.js ガイド][7])
* **Message / Reply（message_reference, allowed_mentions）** ([Discord][17])
* **Threads（アーカイブ一覧/参加/自動Unarchive）** ([Discord][19])
* **Age-Restricted Channels（18+）** / **Safety記事** ([Discordサポート][8])
* **WD14（HFモデル）** / **NudeNet（PyPI/GitHub）** / **ImageHash** ([Hugging Face][14])

---

## 15) 次アクション（Codex向けタスクリスト）

1. **Dev Portal設定**：Intent/Scopes/権限（上記どおり）→招待。 ([Discord.js ガイド][7])
2. **リポ初期化**：構成雛形・`.env.example`・`requirements.txt` 生成。
3. **モデル配置**：WD14（ONNX & tags.csv）DL→`models/wd14/`、`nudenet`初期化。 ([Hugging Face][14])
4. **最小スモーク**：`/ping` と `/notify` で返信・メンション挙動/ジャンプリンク確認。 ([Discordサポート][18])
5. **パイロット走査**：小規模チャンネルで初回走査→混同行列集計→しきい値調整。
6. **運用SOP**：期限（例：72h）・テンプレ文言・レビュー表を確定（JST）。

---

必要なら、この手順書をベースに**`requirements.txt` / `.env.example` / 最小CLI**まで即座に切り出します。文言テンプレ（削除依頼・リマインド）や**権限チェック用の権限セット**も同梱可能です。

[1]: https://support.discord.com/hc/ja/articles/4469963531415-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E5%88%A9%E7%94%A8%E8%A6%8F%E7%B4%84%E3%81%AE%E6%9B%B4%E6%96%B0?utm_source=chatgpt.com "サービス利用規約の更新"
[2]: https://support.discord.com/hc/en-us/articles/360039598252-Protecting-Your-Data?utm_source=chatgpt.com "Protecting Your Data"
[3]: https://support-dev.discord.com/hc/en-us/articles/4404772028055-Message-Content-Privileged-Intent-FAQ?utm_source=chatgpt.com "Message Content Privileged Intent FAQ - Developers - Discord"
[4]: https://discord.com/developers/docs/topics/rate-limits?utm_source=chatgpt.com "Rate Limits | Documentation | Discord Developer Portal"
[5]: https://discord.com/developers/docs/tutorials/configuring-app-metadata-for-linked-roles?utm_source=chatgpt.com "Configuring App Metadata for Linked Roles | Documentation"
[6]: https://discord.com/developers/docs/topics/permissions?utm_source=chatgpt.com "Permissions | Documentation | Discord Developer Portal"
[7]: https://discordjs.guide/preparations/adding-your-bot-to-servers.html?utm_source=chatgpt.com "Adding your bot to servers"
[8]: https://support.discord.com/hc/en-us/articles/115000084051-Age-Restricted-Channels-and-Content?utm_source=chatgpt.com "Age-Restricted Channels and Content"
[9]: https://support.discord.com/hc/en-us/articles/4421269296535-AutoMod-FAQ?utm_source=chatgpt.com "AutoMod FAQ"
[10]: https://discordpy.readthedocs.io/en/latest/api.html?utm_source=chatgpt.com "API Reference - discord.py"
[11]: https://github.com/JohannesBuchner/imagehash?utm_source=chatgpt.com "JohannesBuchner/imagehash: A Python Perceptual Image ..."
[12]: https://huggingface.co/SmilingWolf/wd-v1-4-vit-tagger-v2?utm_source=chatgpt.com "SmilingWolf/wd-v1-4-vit-tagger-v2"
[13]: https://pypi.org/project/nudenet/3.0.1/ "nudenet · PyPI"
[14]: https://huggingface.co/SmilingWolf/wd-v1-4-swinv2-tagger-v2?utm_source=chatgpt.com "SmilingWolf/wd-v1-4-swinv2-tagger-v2"
[15]: https://huggingface.co/SmilingWolf/wd-v1-4-swinv2-tagger-v2/tree/main?utm_source=chatgpt.com "SmilingWolf/wd-v1-4-swinv2-tagger-v2 at main"
[16]: https://github.com/vladmandic/nudenet?utm_source=chatgpt.com "NudeNet: NSFW Object Detection for TFJS and NodeJS"
[17]: https://discord.com/developers/docs/resources/message?utm_source=chatgpt.com "Messages Resource | Documentation"
[18]: https://support.discord.com/hc/en-us/articles/206346498-Where-can-I-find-my-User-Server-Message-ID?utm_source=chatgpt.com "Where can I find my User/Server/Message ID?"
[19]: https://discord.com/developers/docs/topics/threads?utm_source=chatgpt.com "Threads | Documentation | Discord Developer Portal"
[20]: https://discord.js.org/docs/packages/discord-api-types/main/v10/APIAttachment%3AInterface?utm_source=chatgpt.com "APIAttachment (discord-api-types - main)"
[21]: https://discord.com/developers/docs/interactions/application-commands?utm_source=chatgpt.com "Application Commands | Documentation"
[22]: https://discordpy.readthedocs.io/en/stable/ext/commands/api.html?utm_source=chatgpt.com "Context - API Reference - Read the Docs"
[23]: https://discord.com/developers/docs/reference?utm_source=chatgpt.com "API Reference | Documentation | Discord Developer Portal"
[24]: https://support-dev.discord.com/hc/en-us/articles/6223003921559-My-Bot-is-Being-Rate-Limited?utm_source=chatgpt.com "My Bot is Being Rate Limited! - Developers - Discord"
[25]: https://github.com/Tyrrrz/DiscordChatExporter?utm_source=chatgpt.com "Tyrrrz/DiscordChatExporter: Exports Discord chat logs to a ..."
