了解です。**「すぐ効くルール差分」＋ **`/scan` / `/report`** 拡張**を、いまの実装に無理なく差し込める形でまとめました。要所は一次情報（Discord公式・WDタグガーSpace・NudeNet）で裏付けています。

---

# 実装計画書（詳細）

## 0) ゴール & 受け入れ基準（DoD）

* **ルール差分**を反映：`nsfw_margin`／`nsfw_ratio` を導入し、**ORANGE-101**を **「非NSFW ×（nsfw優勢 or 露出）**」に強化。
* **/scan**：オプション `channel`（既定=実行チャンネル）、`since` / `until`（既定=過去7日〜現在）、`severity` を受け付け、**defer→フォローアップ**で応答。*3秒以内にACK → 後追い返信はインタラクショントークン有効時間内*。([Discord][1])
* **/report**：`format=embed|csv|both` を追加。**embed**は**エフェメラル**（Flag=64）で**1件ずつカード＋操作ボタン**（通知・モデログ転送・ページ送り）。([Discord][1])
* **/notify** ボタン：**元投稿に返信**で削除依頼し、**投稿者のみメンション**（`allowed_mentions.users=[author_id]` / `replied_user=false`）。([discord.js][2])

---

## 1) ルール差分（パラメータ調整）

### 1-1. 新規特徴量

* `nsfw_margin = max(q,e) - max(g,s)`
* `nsfw_ratio  = (q+e) / (g+s+q+e + 1e-6)`
  ※ WDタグガーは**rating 4種が相互排他ではなく**独立スコアで出るため（Space実装でも「最初の4つはrating」「argmaxで1つを“見せる”だけ」）、**相対指標**が誤警報抑制に効きます。([Hugging Face][3])

### 1-2. ORANGE-101（配置違反）強化

* 旧：`!is_nsfw && ( q >= 0.35 || exposure >= 0.60 )`
* **新**：

  ```
  !is_nsfw  &&  (
      ( q >= 0.35  &&  ( nsfw_margin >= 0.00  ||  nsfw_ratio >= 0.45 )
        && ( nsfw_general_sum >= 0.20  ||  exposure >= 0.30 ) )
    || ( exposure >= 0.60 )
  )
  ```

  * `nsfw_general_sum` は `bikini, lingerie, nude, breasts, panties, penis ...` 等の**NSFW寄り一般タグの合算**。
  * `exposure` は NudeNet の `EXPOSED_*` 最大スコア（`exposure >= 0.60` を“強露出”の起点に設定）。*NudeNetのクラス/使い方はPyPIに明記。* ([PyPI][4])

> 参考：WDタグガー（v3系列）の**既定しきい値**は Space実装で *general=0.35 / character=0.85*、**MCut**（最大カット法）も実装済み。必要なら一般/キャラはMCutへ切替可能。([Hugging Face][3])

### 1-3. REDの見直し（整理だけ）

* **暴力・ゴア**：`gore_like`（`gore, blood, guro, decapitation, severed, guts, wound ...`）**の合算 or 最大値が基準超** → RED。
* **未成年疑い**：`minors_like`（`loli, shota, child, teen, young ...`）合算が基準超 → RED。
  （*WDのラベル名は `selected_tags.csv` に準拠。*）([Hugging Face][3])

### 1-4. `rules.yaml` 差分例

```yaml
thresholds:
  wd14_questionable: 0.35
  nsfw_margin_min:   0.00
  nsfw_ratio_min:    0.45
  nsfw_general_sum:  0.20
  exposure_mid:      0.30
  exposure_strong:   0.60

rules:
  ORANGE-101:
    title: "配置違反の疑い（18+でない）"
    when: "(!is_nsfw) && ( ((q>=t.wd14_questionable) && (nsfw_margin>=t.nsfw_margin_min || nsfw_ratio>=t.nsfw_ratio_min) && (nsfw_general_sum>=t.nsfw_general_sum || exposure>=t.exposure_mid)) || (exposure>=t.exposure_strong) )"
    render:
      jp: "非NSFWで adult_rating.q={q:.2f}≥{t.wd14_questionable:.2f}（exp={e:.2f}）。margin={nsfw_margin:.2f} ratio={nsfw_ratio:.2f} 露出={exposure:.2f}。"
      action: "notify_author"
      deadline_hours: 72
```

---

## 2) `/scan` 拡張

### 2-1. インターフェイス

```
/scan
  channel: Channel? (未指定=実行チャンネル)
  since:   string?  (未指定=now-7d; ISO8601 or "7d"/"24h")
  until:   string?  (未指定=now)
  severity: red|orange|yellow|all (未指定=all)
  post_summary: bool (既定=false)
```

* **Channel 引数**は**アプリケーションコマンドの Channel 型**で宣言（UIからチャンネル選択）。テキスト系だけ許可可能。([Discord][5])
* 実装は**3秒以内に defer**→バックグラウンド実行→**follow-up**で結果（**インタラクショントークン有効時間内**に返信／編集可）。([Discord][1])

### 2-2. 主要処理

1. 引数正規化 → 対象チャンネルIDと期間で `p2_analysis.jsonl` をフィルタ
2. **evaluate()**（新`rules.yaml`）を適用し `p3_findings.jsonl` に追記
3. `post_summary=true` なら #mod-bot-log にサマリEmbedを投稿（公開）

---

## 3) `/report` 拡張（CSV / Embed / 操作用ボタン）

### 3-1. インターフェイス

```
/report
  channel: Channel? （未指定=実行チャンネル）
  since/until: string?
  severity: red|orange|yellow|all
  format: embed|csv|both  （未指定=embed）
```

### 3-2. 出力仕様

* **format=embed**：

  * **エフェメラル**（Flag=64）で**1件目をカード表示**、**ボタン**：`通知 / リマインド / 期限超過で削除 / #mod-bot-logへ転送 / ◀前 / 次▶`。
  * *エフェメラルはユーザー本人にのみ表示。公開化はできないので、**転送**は新規に #mod-bot-log へ投稿。* ([Discord.Net Docs][6])
* **format=csv**：整形済みCSVを添付（`severity, rule_id, rule_title, reason_jp, action, next_due_h, link, author, ...` の順）
* **format=both**：両方

### 3-3. ボタン動作

* **通知（/notify）**：元投稿**に返信**で削除依頼。`allowed_mentions.users=[author_id]` ＆ `replied_user=false` で**投稿者のみ**メンション（@everyoneを避ける）。([discord.js][2])
* **モデログ転送**：#mod-bot-log に同じEmbed＋操作ログを**新規投稿**
* **ページ送り**：`custom_id` に `page:n` を埋め、**コンポーネントインタラクション**で Embed を差し替え。*Message Componentsの基本仕様に従う。* ([Hugging Face][7])

---

## 4) データ面の差分

### 4-1. 追加列（`p3_findings.jsonl` / `/report` CSV）

* `nsfw_margin, nsfw_ratio, nsfw_general_sum`
* `reason_jp`（短文）／`rule_id`／`rule_title`／`action`／`deadline_hours`
* 既存の `exposure_score`（NudeNet由来）、`message_link`、`author_id` 等は維持

> **WDラベル & MCut**、**ratingの扱い**はSpace実装に準拠（前処理・ラベル分割・MCutの実装が明示）。([Hugging Face][3])

### 4-2. スキーマ更新

```json
{
  "wd14": { "rating": { "general":0.55, "sensitive":0.06, "questionable":0.39, "explicit":0.21 }, "general": {...} },
  "nudity_detections":[{"class":"EXPOSED_GENITALIA_F","score":0.88,"box":[...]}],
  "xsignals": { "exposure_score":0.00, "nsfw_margin":-0.16, "nsfw_ratio":0.40, "nsfw_general_sum":0.05 }
}
```

---

## 5) 実装差分（擬似コード）

### 5-1. ルール前処理

```python
def enrich_features(row):
    g, s = row['wd14']['rating'].get('general',0), row['wd14']['rating'].get('sensitive',0)
    q, e = row['wd14']['rating'].get('questionable',0), row['wd14']['rating'].get('explicit',0)
    row['xsignals']['nsfw_margin'] = max(q,e) - max(g,s)
    denom = g+s+q+e + 1e-6
    row['xsignals']['nsfw_ratio']  = (q+e)/denom
    nsfw_tags = ['bikini','lingerie','nude','breasts','panties','penis']  # 初期集合
    row['xsignals']['nsfw_general_sum'] = sum(row['wd14']['general'].get(t,0) for t in nsfw_tags)
    return row
```

### 5-2. /scan（defer→follow-up）

```python
@tree.command(name="scan")
async def scan(inter, channel: discord.abc.GuildChannel|None=None, since:str|None=None, until:str|None=None, severity:str="all", post_summary:bool=False):
    await inter.response.defer(ephemeral=True)  # 3秒内ACK → 後で回答 :contentReference[oaicite:13]{index=13}
    ch = channel or inter.channel
    t0, t1 = parse_range(since, until, days=7)
    rows = load_analysis(ch.id, t0, t1)
    enriched = [enrich_features(r) for r in rows]
    findings = [evaluate(r, is_nsfw(ch), rules_cfg) for r in enriched]
    save_findings(findings)
    await inter.followup.send(f"scan done: {len(findings)} items", ephemeral=True)
```

### 5-3. /report（Embed＋ボタン）

```python
@tree.command(name="report")
async def report(inter, channel:discord.abc.GuildChannel|None=None, since:str|None=None, until:str|None=None, severity:str="orange", format:str="embed"):
    target = channel or inter.channel
    t0, t1 = parse_range(since, until, days=7)
    rows = load_findings(target.id, t0, t1, severity)
    if format in ("embed","both"):
        await inter.response.send_message(embed=render_embed(rows[0]), view=ReportView(rows, start=0), ephemeral=True)
    if format in ("csv","both"):
        await inter.followup.send(file=render_csv(rows), ephemeral=True)
```

### 5-4. ボタン：通知（/notify 相当）

```python
async def send_notify_reply(message: discord.Message, author_id: int, due_hours=72):
    allowed = discord.AllowedMentions(everyone=False, roles=False, users=[discord.Object(author_id)], replied_user=False)  # 投稿者のみメンション :contentReference[oaicite:14]{index=14}
    await message.reply(content=build_notify_text(due_hours), allowed_mentions=allowed)
```

---

## 6) テスト計画（要点）

* **規則**：

  * `q>=0.35` でも `nsfw_margin<0` かつ `exposure<0.30` なら **ORANGE不発**（YELLOW or CLEAN）。
  * `exposure>=0.60` なら **ORANGE成立**（非NSFW時）。
* **/scan**：`channel未指定→実行チャンネル`、`since/until未指定→過去7日〜現時点` を確認。**defer→follow-up**のフローでタイムアウトしない。([Discord][1])
* **/report=embed**：**1件目のカード**がエフェメラルで表示され、ボタンが働く（通知は返信・投稿者のみメンション／モデログ転送は公開投稿）。([Discord.Net Docs][6])
* **CSVの可読性**：先頭に `severity, rule_id, rule_title, reason_jp, action, next_due_h, link, author...` を配置。
* **WD/NudeNet根拠**：WDの**ラベル分割・既定しきい値・MCut**はSpace実装に一致／NudeNetは `detect_batch` でクラス名・スコアが得られる。([Hugging Face][3])

---

## 7) 権限・UXメモ

* **権限制御**：`/scan` や削除系ボタンは\*\*モデレーター権限（例：Manage Messages）\*\*以上に限定（アプリコマンド権限/チャンネル別制限を利用）。([Discord][5])
* **チャンネル型の制限**：`Channel`引数は**テキスト系のみ**許可（discord.pyの`channel_types`等で絞り込めます）。([discordpy.readthedocs.io][8])
* **エフェメラルの扱い**：**公開化できない**ため、共有が必要なカードは**転送ボタン→#mod-bot-logへ新規投稿**で運用。([Discord][1])

---

## 8) 参考（根拠リンク）

* **Interactions（3秒応答・defer／フォローアップ・エフェメラル Flag=64）**：Discord公式 & API型定義。([Discord][1])
* **Application Commands（引数/チャンネル型・権限）**：Discord公式／discord.pyリファレンス。([Discord][5])
* **WDタグガー（v3系列）Space実装**：general=0.35 / character=0.85、**「最初の4つはrating」**、**MCut**の実装、前処理。([Hugging Face][3])
* **NudeNet**：`detect` / `detect_batch` のI/O、**EXPOSED\_**\* クラス一覧。([PyPI][4])

---

### 最後に

この計画なら、**“モノクロ系で `q≈0.39` が並ぶ誤警報”**を**nsfwバランス＋露出**で抑えつつ、**UIはEmbed＋ボタン**でそのまま運用に乗ります。
準備OKなら、**`rules.yaml` 差分・`/scan` `/report` の引数拡張・ReportView実装**の3PRに分けて進めるのが安全です。

[1]: https://discord.com/developers/docs/interactions/receiving-and-responding?utm_source=chatgpt.com "Interactions | Documentation | Discord Developer Portal"
[2]: https://discord.js.org/docs/packages/discord-api-types/main/v10/APIAllowedMentions%3AInterface?utm_source=chatgpt.com "APIAllowedMentions (discord-api-types - main)"
[3]: https://huggingface.co/spaces/SmilingWolf/wd-tagger/blame/main/app.py "app.py · SmilingWolf/wd-tagger at main"
[4]: https://pypi.org/project/nudenet/?utm_source=chatgpt.com "nudenet"
[5]: https://discord.com/developers/docs/interactions/application-commands?utm_source=chatgpt.com "Application Commands | Documentation"
[6]: https://docs.discordnet.dev/api/Discord.MessageFlags.html?utm_source=chatgpt.com "Enum MessageFlags"
[7]: https://huggingface.co/spaces/SmilingWolf/wd-tagger/blame/main/app.py?utm_source=chatgpt.com "app.py · SmilingWolf/wd-tagger at main"
[8]: https://discordpy.readthedocs.io/en/latest/interactions/api.html?utm_source=chatgpt.com "Interactions API Reference - discord.py"
