# P0 実装計画書（最小スキャナ）

**対象**：Discord サーバーの**過去履歴**を走査し、**画像添付/画像埋め込み**を抽出 → **pHash** を計算 → **CSV に出力**
**非対象**：分類（WD14/NudeNet）・通知・期限管理（P1以降）
**所要**：〜1日（既に Bot 招待・疎通済み前提）

---

## 1) 目的・完了基準（DoD）

**目的**

* サーバーの**全テキストチャンネル＋スレッド（アーカイブ含む）**で、画像（attachment / embed image）を**漏れなく列挙**し、

  * 各画像の**メタ**（投稿ジャンプリンク、投稿者、チャンネル、時刻、NSFWフラグ 等）
  * **pHash**（重複検知用）
    を **CSV** に出力する。

**DoD（Definition of Done）**

* 任意のチャンネル/スレッドで **最古→最新（`oldest_first`）** の順に履歴走査ができること。([discordpy.readthedocs.io][1])
* **attachments** と **embeds.image** の双方から**画像 URL** を抽出できること（`content_type` や拡張子で `image/*` 判定、`attachment://` 参照も考慮）。([discord-api-types documentation][2])
* 各ヒットに **ジャンプリンク** `https://discord.com/channels/{guild}/{channel}/{message}` を付与できること（UI の「メッセージリンクをコピー」と同形式）。([ディスコードサポート][3])
* 各画像の **pHash** を算出し、**CSV** に `phash_hex` として出力できること（`imagehash` の `phash` を使用）。([PyPI][4])
* **レート制限 (global 50 req/s)** と **429 の `retry_after`** を尊重して安全に完走できること。([Discord][5])
* **再開可能**（カーソル保存）で中断から復帰できること。

---

## 2) 前提・権限・設計ポリシー（抜粋）

* **権限**：`View Channels`, `Read Message History` が**履歴取得**に必須。削除権限は不要（P0では削除しない）。([Discord][6])
* **Message Content Intent**：履歴から **attachments / embeds** を受け取るには、**Message Content** 特権 Intent が未承認だと**空配列**になる場合があるため（100サーバー未満はポータルONでOK）、**ONを推奨**。([Discord Developer Support][7])
* **スレッド**：**アーカイブ済み**スレッドは**一覧API**から取得可能。投稿時は自動 Unarchive される（今回は読むだけ）。([Discord][6])
* **ジャンプリンク**：公式ヘルプに**コピー手順**あり（形式は `/channels/{guild}/{channel}/{message}`）。([ディスコードサポート][3])
* **CDN**：Discord 添付 URL は**署名付き**で、**期限性**に注意（取得できなければ「取得不能」と記録）。([Discord][8])

---

## 3) 出力スキーマ（CSV / UTF-8）

`out/p0_scan.csv`（ヘッダつき）

| col名                 | 型    | 説明                                                           |
| -------------------- | ---- | ------------------------------------------------------------ |
| guild\_id            | str  | サーバーID                                                       |
| channel\_id          | str  | チャンネル/スレッドID                                                 |
| message\_id          | str  | メッセージID                                                      |
| message\_link        | str  | `https://discord.com/channels/{guild}/{channel}/{message}`   |
| created\_at          | str  | ISO8601（UTC）                                                 |
| author\_id           | str  | 投稿者ID                                                        |
| is\_nsfw\_channel    | bool | チャンネルの 18+/NSFW フラグ（`is_nsfw()`） ([Pycord][9])               |
| source               | enum | `"attachment"` or `"embed"`                                  |
| attachment\_id       | str? | attachments の snowflake（embed時は空） ([Discord][10])            |
| filename             | str? | 添付名（embed時は推定可）                                              |
| content\_type        | str? | 例: `image/png`（不明なら空） ([discord-api-types documentation][2]) |
| file\_size           | int? | bytes（HEAD/メタで取得・不明可）                                        |
| url                  | str  | 画像取得URL（必要に応じ proxy\_url） ([discordpy.readthedocs.io][11])   |
| phash\_hex           | str  | 16文字×?（64bitなど） ([PyPI][4])                                  |
| phash\_distance\_ref | int? | 近傍重複があれば距離                                                   |
| note                 | str? | 例: `fetch_failed`, `unsupported_media`                       |

**補助キャッシュ**：`out/phash_cache.csv`（`url, phash_hex`）— 同一画像の**重複スキップ**に使用。([PyPI][4])

---

## 4) ディレクトリ構成（P0）

```
modbot/
  app/
    p0_scan.py           # CLIエントリ
    discord_client.py    # クライアント生成・共通
    iterators.py         # チャンネル/スレッド/履歴の列挙
    extractors.py        # attachments / embeds から画像URL抽出
    downloader.py        # HEAD/GET with 429対応
    phash.py             # Pillow+imagehash
    csvsink.py           # CSV出力/排他書き込み
    state.py             # カーソル保存・復帰
    util.py
  out/
  .env
```

---

## 5) 実装手順（詳細）

### 5.1 Discord 走査（履歴→最古→最新）

* `TextChannel.history(limit=None, oldest_first=True, before/after/around 排他)` で**非同期反復**。最古から順に安全に辿る。([discordpy.readthedocs.io][1])
* **スレッド対応**：ギルド内の**アクティブ＋アーカイブ**スレッドを**一覧取得**し、それぞれで同様に `history()` を回す。([Discord][12])
* **カーソル**：チャンネルごとに `last_message_id` を `state.json` に保存。中断復帰時は `after=last_message_id` で再開。([Discord][10])

### 5.2 画像抽出（attachments / embeds）

* **attachments**：`message.attachments` を走査。`Attachment.content_type` が `image/` であれば対象（`None` の場合は拡張子で消極判定）。([Stack Overflow][13])

  * 取得フィールド例：`id, url, proxy_url, filename, content_type, size, width, height`（API 構造は Attachment 参照）。([Discord][10])
* **embeds**：`message.embeds` を走査。`embed.image` / `embed.thumbnail` の **`url` / `proxy_url` / `content_type`** を読み出し（`attachment://` 参照にも対応）。([discordpy.readthedocs.io][11])
* **Intent注意**：Message Content 未承認だと **attachments/embeds が空**で届くことがある（100サーバー未満はポータルONで回避可能）。([Discord Developer Support][7])

### 5.3 取得と pHash（重複排除）

* **HEAD→GET 戦略**：まず `HEAD` で `Content-Type` と `Content-Length` を確認し、`image/*` 以外はスキップ。`429` は `retry_after` で待機。([Discord Developer Support][14])
* **CDN事情**：**署名付き添付URL**は失効しうる。GET 失敗は `note=fetch_failed` で記録。([Discord][8])
* **pHash**：Pillow で RGB 変換→縮小→ `imagehash.phash(img)` を 16進文字列で保存。**重複**はキャッシュ照合（ハミング距離≤5等で同一扱い）し、同一なら**再DLをスキップ**。([PyPI][4])

### 5.4 CSV 出力

* 各ヒットに **ジャンプリンク**を生成：`f"https://discord.com/channels/{guild}/{channel}/{message}"`（ヘルプの「メッセージリンクをコピー」と同形式）。 ([ディスコードサポート][3])
* `csv.DictWriter` で逐次追記。排他/整合性のため**一時ファイル→アトミック移動**。

### 5.5 レート制限・信頼性

* **Discord global**：**50 req/s** を厳守。429 では **`X-RateLimit-Scope: global`** と **`retry_after`** を見てスリープ。([Discord][5])
* `history()` 自体は discord.py がルート別レートを面倒見するが、**外部GET/HEAD** は自前で QPS 制御。([Reddit][15])

---

## 6) 主要関数の仕様（擬似コード）

```python
# app/p0_scan.py
# 用途: 既存Botトークンでログイン -> 全チャンネル/スレッドを最古→最新で走査し CSV へ
# 依存: discord.py, aiohttp, Pillow, imagehash

async def iter_text_channels_and_threads(guild) -> AsyncIterator[abc.Messageable]:
    # ギルドのテキストチャンネル列挙
    for ch in guild.text_channels:
        yield ch
        # スレッド: アクティブ + アーカイブ（必要に応じ API でページング取得）
        for th in ch.threads:
            yield th
        # ※ アーカイブ一覧取得は Threads API で可能（検索/列挙）。:contentReference[oaicite:29]{index=29}

async def scan_history(dst, after_id=None):
    # oldest_first=True で最古から :contentReference[oaicite:30]{index=30}
    async for m in dst.history(limit=None, oldest_first=True, after=discord.Object(id=after_id) if after_id else None):
        for att in m.attachments:
            # content_type が image/* かを確認（不明は拡張子で補助） :contentReference[oaicite:31]{index=31}
            yield ("attachment", att, m)
        for emb in m.embeds:
            if emb.image or emb.thumbnail:
                yield ("embed", emb, m)

async def head_then_get(session, url) -> bytes|None:
    # 429 は retry_after で待機 :contentReference[oaicite:32]{index=32}
    # Content-Type が image/* 以外はスキップ
    ...

def compute_phash(pil_img) -> str:
    # imagehash.phash() を16進文字列にして返す :contentReference[oaicite:33]{index=33}
    ...

def make_message_link(gid, cid, mid) -> str:
    return f"https://discord.com/channels/{gid}/{cid}/{mid}"  # ヘルプ記載の形式 :contentReference[oaicite:34]{index=34}
```

---

## 7) 実行フロー（CLI）

```
$ python -m app.p0_scan --guild <GUILD_ID> \
  [--since 2024-01-01] [--channels #general,#art] [--include-archived-threads] \
  [--resume] [--qps 10] [--out out/p0_scan.csv]
```

* `--since`：開始日時（ISO）。内部では `after` に変換（`before/after/around` は相互排他）。([Discord][10])
* `--resume`：`state.json` のカーソルから再開。
* `--qps`：外部（CDN等）への HEAD/GET 上限。
* `--include-archived-threads`：アーカイブ一覧 API を使って追加走査。([Discord][12])

---

## 8) 検証チェックリスト

* **履歴の順序**：`oldest_first=True` で**最古→最新**になっている。([discordpy.readthedocs.io][1])
* **抽出網羅性**：`attachments` と `embeds.image/thumbnail` から**双方**抽出できる（Intent の影響を受ける点に注意）。([Discord Developer Support][7])
* **NSFW フラグ**：`channel.is_nsfw()` を CSV に反映。([Pycord][9])
* **ジャンプリンク**：CSV のリンクから**該当メッセージへ遷移**可能（権限のあるユーザー）。([ディスコードサポート][3])
* **レート制御**：429 時に `retry_after` 待機している。**Global 50 rps** を超えない。([Discord][5])
* **pHash 重複**：同一画像で距離≤5 ならスキップ/同定できる。([PyPI][4])

---

## 9) 既知の限界・運用注意

* **Intent 未承認時の欠落**：Message Content が未承認だと**attachments/embeds が空**で届くケースがある（Botが100サーバー未満なら**開発者ポータルでON**）。([Discord Developer Support][7])
* **CDN 失効**：古い添付は**署名URLの期限切れ**で取得不能あり（`note=fetch_failed` とし、必要なら **fetch\_message** で**最新URL**再取得）。([Discord][8])
* **外部埋め込み**：外部ホスト（例：Tenor/Gyazo）などは**CORS/HEAD拒否**や**期限**で失敗しうる（可能なら `proxy_url` を試行）。([discordpy.readthedocs.io][11])

---

## 10) 成功のコツ（実務メモ）

* **段階処理**：まず **URL 正規化+キャッシュ照合** → 未処理のみ GET → pHash。
* **画像前処理**：`max(長辺)=512` 程度に縮小して pHash（処理時間とロバスト性のバランスが良い）。([PyPI][4])
* **ログ**：`INFO` に進捗、`WARN` に fetch 失敗、`DEBUG` にヘッダ詳細。
* **小規模パイロット**：まず 1–2 チャンネルで総当たり→所要時間と CSV 項目を確かめる。

---

## 11) 参考（一次情報中心）

* **レート制限**（Global 50 rps / `retry_after` / scope: global）([Discord][5])
* **Message Content Intent（未承認だと attachments/embeds 空の可能性）** ([Discord Developer Support][7])
* **履歴取得 `history()` と `oldest_first`**（2.6+）([discordpy.readthedocs.io][1])
* **メッセージリンク（コピー手順/ジャンプ形式）** ([ディスコードサポート][3])
* **スレッド（アーカイブ列挙/自動Unarchiveメモ）** ([Discord][6])
* **Attachment/Embed のメディア項目**（`content_type` / `proxy_url` / `attachment://`）([discord-api-types documentation][2])
* **pHash / imagehash**（Python 実装）([PyPI][4])

---

### 次アクション（Codex 連携用メモ）

1. 上記構成で**雛形ファイル生成**（`p0_scan.py` と各モジュールのstub）。
2. `.env` に `DISCORD_BOT_TOKEN`, `GUILD_ID` を設定。
3. **1–2チャンネルで試走**（`--since` を直近1週間等に）→ CSV 出力確認。
4. 問題なければ `--include-archived-threads` を ON にし、**全域フルスキャン**へ。

必要なら、この計画に沿った**最小実装テンプレ**（約150行）をすぐ切り出します。

[1]: https://discordpy.readthedocs.io/en/latest/api.html?utm_source=chatgpt.com "API Reference - Discord.py"
[2]: https://discord-api-types.dev/api/discord-api-types-v10/interface/APIAttachment?utm_source=chatgpt.com "APIAttachment | API | discord-api-types documentation"
[3]: https://support.discord.com/hc/en-us/articles/206346498-Where-can-I-find-my-User-Server-Message-ID?utm_source=chatgpt.com "Where can I find my User/Server/Message ID?"
[4]: https://pypi.org/project/ImageHash/?utm_source=chatgpt.com "ImageHash"
[5]: https://discord.com/developers/docs/topics/rate-limits?utm_source=chatgpt.com "Rate Limits | Documentation | Discord Developer Portal"
[6]: https://discord.com/developers/docs/resources/channel?utm_source=chatgpt.com "Channels Resource | Documentation"
[7]: https://support-dev.discord.com/hc/en-us/articles/4404772028055-Message-Content-Privileged-Intent-FAQ "Message Content Privileged Intent FAQ – Developers"
[8]: https://discord.com/developers/docs/reference?utm_source=chatgpt.com "API Reference | Documentation | Discord Developer Portal"
[9]: https://docs.pycord.dev/en/master/_modules/discord/channel.html?utm_source=chatgpt.com "discord.channel - Pycord v2.7 Documentation"
[10]: https://discord.com/developers/docs/resources/message?utm_source=chatgpt.com "Messages Resource | Documentation"
[11]: https://discordpy.readthedocs.io/en/latest/interactions/api.html?utm_source=chatgpt.com "Interactions API Reference - discord.py"
[12]: https://discord.com/developers/docs/topics/threads?utm_source=chatgpt.com "Threads | Documentation | Discord Developer Portal"
[13]: https://stackoverflow.com/questions/74226299/discord-py-is-there-any-way-to-check-that-sent-attachment-is-image?utm_source=chatgpt.com "(Discord.py) Is there any way to check that sent attachment ..."
[14]: https://support-dev.discord.com/hc/en-us/articles/6223003921559-My-Bot-is-Being-Rate-Limited?utm_source=chatgpt.com "My Bot is Being Rate Limited! - Developers - Discord"
[15]: https://www.reddit.com/r/Discord_Bots/comments/wny4e1/how_to_export_channel_history_as_a_text_file/?utm_source=chatgpt.com "How to export channel history as a text file using discord.py?"
